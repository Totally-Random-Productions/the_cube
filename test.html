<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Test</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.54.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
        canvas {  
            padding: 1px;
            margin: auto;
            display: block;
            width: 1280px;
            height: 720px;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            border: black;
            border-style: solid;
            border-width: 5px;
        }
    </style>
</head>
<body>
    <script type="text/javascript">

        /*creates a new scene while extending the Phaser Scene Class 
        so that the default functions remain the same*/
        var StartScene = new Phaser.Class({

            Extends: Phaser.Scene,

            initialize:

            function StartScene ()
            {
                Phaser.Scene.call(this, { key: 'start' });
            },

            init: function()//called everytime the scene restarts. I use it to declare variables, 'this' is used so that the scope of the variables is only within this scene.
            {
                this.startbutton;
                this.leaderbutton;
                this.creditsbutton;
                this.settingsbutton;
            },

            preload: function ()
            {
                this.load.image('startbt', 'testob/menustart.png');
                this.load.image('back', 'testob/menuback.png');
                this.load.image('leader', 'testob/menuleader.png');
                this.load.image('credit', 'testob/menucredits.png');
                this.load.image('settings', 'testob/menusettings.png');
            },

            create: function ()
            {
                this.add.image(0, 0, 'back').setOrigin(0);
                this.startbutton = this.add.image(1280/2, 720-610, 'startbt').setInteractive();
                this.settingsbutton = this.add.image(1280/2, 720-455, 'settings').setInteractive();
                this.leaderbutton = this.add.image(1280/2, 720-300, 'leader').setInteractive();
                this.creditsbutton = this.add.image(1280/2, 720-145, 'credit').setInteractive();
                
                this.startbutton.on('pointerdown', function () {
                    this.scene.start('game');
                }, this);

                this.startbutton.on('pointerover', function () {
                    this.startbutton.setScale(1.2);
                }, this);

                this.startbutton.on('pointerout', function () {
                    this.startbutton.setScale(1);
                }, this);

                this.leaderbutton.on('pointerdown', function () {
                    this.scene.start('leader');
                }, this);

                this.settingsbutton.on('pointerdown', function () {
                    this.scene.start('settings');
                }, this);

                this.settingsbutton.on('pointerover', function () {
                    this.settingsbutton.setScale(1.2);
                }, this);

                this.settingsbutton.on('pointerout', function () {
                    this.settingsbutton.setScale(1);
                }, this);

                this.leaderbutton.on('pointerover', function () {
                    this.leaderbutton.setScale(1.2);
                }, this);

                this.leaderbutton.on('pointerout', function () {
                    this.leaderbutton.setScale(1);
                }, this);

                this.creditsbutton.on('pointerdown', function () {
                    this.scene.start('credits');
                }, this);

                this.creditsbutton.on('pointerover', function () {
                    this.creditsbutton.setScale(1.2);
                }, this);

                this.creditsbutton.on('pointerout', function (event) {
                    this.creditsbutton.setScale(1);
                }, this);
            }

            });

        var GameScene = new Phaser.Class({
            Extends: Phaser.Scene,

            initialize:

            function GameScene ()
            {
                Phaser.Scene.call(this, { key: 'game' });
            },

            init: function()
            {
                    this.flyingWeapon=[];
                    this.mplatforms = [];
                    this.platforms;
                    this.isOnGround = false;
                    this.player;
                    this.spike;
                    this.turret;
                    this.pillars;
                    this.base;
                    this.trophy;
                    this.aggrox;
                    this.aggroy;
                    this.target;
                    this.gameOver;
                    this.gameWin;
                    this.secondsDecimal = 0;
                    this.minutes = 0;
                    this.timer;
                    this.timerEvent;
                    this.jumps;
                    this.bullet;
                    this.bulletTimer;
                    this.aiming;
            },

            preload: function ()
            {
                this.load.image('back', 'testob/back.png');
                this.load.image('plat', 'testob/plat.png');
                this.load.image('spike', 'testob/spike.png');
                this.load.image('floor', 'testob/flo.png');
                this.load.image('star', 'testob/star.png');
                this.load.image('cube', 'testob/cube1.png');
                this.load.image('death', 'testob/cube3.png');
                this.load.image('pil', 'testob/pil.png');
                this.load.image('tur', 'testob/turret1.png');
                this.load.image('trophy', 'testob/prize.png');
                this.load.image('base', 'testob/base.png');
                this.load.image('circ', 'testob/circle.png');
                this.load.image('bullet', 'testob/bullet.png');
            },

            create: function ()
            {
                this.cameras.main.setBounds(0, 0, 1280 * 2, 720); //stops the camera from leaving the game area
                this.physics.world.setBounds(0, 0, 1280 * 2, 720);//sets the game area where physics is applied

                this.add.image(0, 0, 'back').setOrigin(0);
                this.add.image(1280, 0, 'back').setOrigin(0);
                this.add.image(1280*2, 0, 'back').setOrigin(0);

                this.timerEvent = this.time.addEvent({delay: 100, callback: this.updateTime, callbackScope: this, loop: true})
                this.timer = this.add.text(16, 16, '0: 00', { fontSize: '32px', fill: '#000' });
                this.timer.scrollFactorX = 0;

                this.flyingWeapon[0] = this.physics.add.sprite(50, 400, 'star').setCircle(20);
                this.flyingWeapon[0].body.setGravityY(-300);//sets gravity to negative of the world gravity so the object cannot be moved by gravity
                this.flyingWeapon[1] = this.physics.add.sprite(1400, 300, 'star').setCircle(20);
                this.flyingWeapon[1].body.setGravityY(-300);

                this.platforms = this.physics.add.staticGroup(); //creates a new group for this.platforms. They cannot move at all
                this.platforms.create(400, 500, 'plat');
                this.platforms.create(700, 380, 'plat');
                this.platforms.create(900, 260, 'plat');
                this.platforms.create(1000, 175, 'plat');

                this.mplatforms[0] = this.physics.add.sprite(1600, 500, 'plat'); //creates a sprite for this.mplatforms[] This can move.
                this.mplatforms[0].body.setGravityY(-300);
                this.mplatforms[0].setImmovable(true); //the sprite can still move, but it cannot be moved by collision with other objects

                this.spike = this.physics.add.staticGroup();
                this.spike.create(400, 453, 'spike');
                this.spike.create(1305, 700, 'spike');
                this.spike.create(1305+50, 700, 'spike');
                this.spike.create(1305+100, 700, 'spike');
                this.spike.create(1305+150, 700, 'spike');
                this.spike.create(1305+200, 700, 'spike');
                this.spike.create(1305+250, 700, 'spike');
                this.spike.create(1305+300, 700, 'spike');
                this.spike.create(1305+350, 700, 'spike');
                this.spike.create(1305+400, 700, 'spike');

                this.pillars = this.physics.add.staticGroup();
                this.pillars.create(2100, 250, 'pil');
                this.pillars.create(2400, 550, 'pil');

                this.base = this.physics.add.sprite(2130, 300, 'base').setOrigin(0, 0.5);
                this.base.setScale(1.25);
                this.base.body.setGravityY(-300);
                this.base.setImmovable(true);

                this.turret = this.physics.add.sprite(2150, 300, 'tur').setOrigin(0, 0.5);
                this.turret.body.setGravityY(-300);
                this.turret.setImmovable(true);

                this.bullet = this.physics.add.sprite(this.turret.x, this.turret.y, 'bullet');
                this.bullet.body.setGravityY(-300);
                this.bulletTimer = this.time.addEvent({delay: 1500, callback: this.shootBullet, callbackScope: this, loop: true})

                this.trophy = this.physics.add.sprite(2500, 200, 'trophy').setScale(0.3);
                this.trophy.setCollideWorldBounds(true); //prevents the object from falling through the world

                this.floor = this.physics.add.staticGroup();
                this.floor.create(640, 670, 'floor');
                this.floor.create(2370, 670, 'floor');

                this.player = this.physics.add.sprite(100, 470, 'cube').setScale(1.6);
                this.player.setBounce(0.1);
                this.player.setCollideWorldBounds(true);
                this.player.body.setGravityY(900);

                this.physics.add.collider(this.player, this.platforms);
                this.physics.add.collider(this.player, this.floor); //checks to see if the objects collide
                this.physics.add.collider(this.player, this.mplatforms);
                this.physics.add.collider(this.player, this.pillars);
                this.physics.add.collider(this.floor, this.trophy);
                this.physics.add.collider(this.player, this.spike, this.hit, null, this); //checks to see if the objects collide, passes the objects to the function 'hit' if they do
                this.physics.add.collider(this.player, this.flyingWeapon, this.hit, null, this);
                this.physics.add.collider(this.player, this.bullet, this.hit, null, this);
                this.physics.add.collider(this.player, this.turret, this.hit, null, this);
                this.physics.add.overlap(this.player, this.trophy, this.win, null, this); //checks to see if the objects overlap, passes the objects to the function 'win' if they do

                this.cursors = this.input.keyboard.createCursorKeys(); //creates inputs using the arrow keys
                this.cameras.main.startFollow(this.player, true, 0.05, 0.05); //makes the camera track the player. increasing the numbers makes the camera track faster
            },

            update: function()
            {
                this.aiming=false;
                this.groundCheck();
                this.aggrox = Phaser.Math.Difference(this.turret.x, this.player.x); //finds the positive x distance between the player and turret
                this.aggroy = Phaser.Math.Difference(this.turret.y, this.player.y); //finds the positive y distance between the player and turret
                
                if(this.aggrox <= 450 && this.aggroy <= 350)
                {
                    this.target = Phaser.Math.Angle.BetweenPoints(this.turret, this.player);//finds the angle between the turret and player
                    if(this.target > -1.5 && this.target < 1.5)
                    {
                        this.turret.rotation = this.target; // sets the turrets angle of rotation to the angle found above
                        this.aiming = true;
                    }
                }

                this.flyingWeapon[0].rotation+=0.2; //sets rotation and velocity of moving obstacles
                if (this.flyingWeapon[0].x>300)
                {
                    this.flyingWeapon[0].setVelocityX(-150);
                }
                else if (this.flyingWeapon[0].x<100)
                {
                    this.flyingWeapon[0].setVelocityX(150);
                }

                this.flyingWeapon[1].rotation+=0.2;
                if (this.flyingWeapon[1].y<=300)
                {
                    this.flyingWeapon[1].setVelocityY(150);
                }
                else if (this.flyingWeapon[1].y>500)
                {
                    this.flyingWeapon[1].setVelocityY(-150);
                }
                //end of moving obstacles

                if (this.mplatforms[0].x<=1600) //sets velocity of moving platforms
                {
                    this.mplatforms[0].setVelocityX(100);
                }

                else if (this.mplatforms[0].x>1860)
                {
                    this.mplatforms[0].setVelocityX(-100);
                }
                //end of moving platforms
                
                if (this.gameOver) //true if player is hit by lethal object, determined by function 'hit'
                {
                    //starts the GameOver Scene after set amount of time
                    this.time.addEvent({  
                    delay: 1000,
                    loop: false,
                    callback: () => {
                        this.scene.start('over');
                       /* setTimeout(() => {
                            this.scene.stop('over')
                            this.scene.start('start');
                        }, 2000)*/
                    }
                })
               }

            //PLayer Controls
            if(!this.gameWin){
                if(!this.cursors.up.isDown && this.isOnGround)
                {
                    this.jumps = 2;
                }

                if (this.cursors.left.isDown && !this.cursors.right.isDown)
                {
                    this.player.setVelocityX(-350);
                }
                else if (this.cursors.right.isDown && !this.cursors.left.isDown)
                {
                    this.player.setVelocityX(350);                    
                }
                else
                {
                    this.player.setVelocityX(0);
                }

                if (this.cursors.down.isDown) //flattens player if down arrow is pressed
                {
                    this.player.setDisplaySize(100, 25);
                }


                if(Phaser.Input.Keyboard.JustDown(this.cursors.up) && this.jumps > 0)
                {
                    if(!this.isOnGround)
                    {
                        this.jumps = 1;
                    }

                    if (this.player.body.touching.left)
                    {
                        this.player.setVelocityY(-630);
                        this.player.setVelocityX(350)
                        this.jumps = 1;
                    }

                    if(this.player.body.touching.right)
                    { 
                        this.player.setVelocityY(-630);
                        this.player.setVelocityX(-350);
                        this.jumps = 1;
                    }
                    this.player.setVelocityY(-630);
                    this.jumps--;
                    // up arrow must be pressed each time the player wants to jump
                    
                    if(this.player.setDisplaySize(100, 25))
                    {
                        this.player.setDisplaySize(30, 30).setScale(1.6);
                    }
                }
                
            }
                // end of Player Controls
            },
            groundCheck: function(){
                if(this.player.body.touching.down)
                {
                    this.isOnGround = true;
                }

                else
                {
                    this.isOnGround = false;
                }

                if (this.player.body.touching.left || this.player.body.touching.right)
                {
                    this.jumps = 1;
                }
                
            },

            shootBullet: function()
            {
                if(this.aiming)
                {
                    this.physics.velocityFromRotation(this.turret.rotation, 300, this.bullet.body.velocity);
                    this.bullet.x = this.turret.x;
                    this.bullet.y = this.turret.y; 
                    this.bullet.body.setGravityY(-300);                
                }

            },

            hit: function(player, obst)
            {
                this.physics.pause();
                player.setDisplaySize(50, 50);
                player.setTexture('death');
                this.gameOver = true;
            },

            win: function(player, obj)
            {
                console.log('Good job'); //tells you good job for winning because i don't have a win screen yet
                
                
                if(this.isOnGround == true){
                    obj.disableBody(true, true);
                    this.player.setVelocityX(0); //U cud also use this but
                    this.input.disable = true//input disable makes the player not be able to do anything whatsoever
                     this.player.setCollideWorldBounds(false);
                    setTimeout(() => { 
                    this.player.setVelocityX(500); 
                          console.log('true')
                    
                    this.time.addEvent({  
                    delay: 500,
                    loop: false,
                    callback: () => {
                        this.physics.pause();
                    }
                    
                })

                this.time.addEvent({  
                    delay: 500,
                    loop: false,
                    callback: () => {
                        this.scene.start('win');
                    }
                    
                })
                        //restart
                        setTimeout(() => {
                        this.scene.stop('win');
                        this.scene.start('start');
                        console.log('start scene')
                        
                           
                                          }, 2000);
                    }, 1000);
                    
                   
                   
                    
              
                
                }
                
                this.gameWin = true;
                 
            },

            updateTime: function()
            {
                this.secondsDecimal++;
                if(this.secondsDecimal===599)
                {
                    this.secondsDecimal=0;
                    this.minutes++;
                }
                
                if(this.gameWin || this.gameOver)
                {
                    this.timerEvent.remove(false);
                    //some php for leader board
                }

                this.timer.setText('0' + this.minutes + ':' + this.secondsDecimal/10);
            }

        });

        var GameOverScene = new Phaser.Class({

            Extends: Phaser.Scene,

            initialize:

            function GameOverScene ()
            {
                Phaser.Scene.call(this, { key: 'over' });
            },

            init: function()
            {

            },

            preload: function ()
            {
                this.load.image('die', 'testob/die.png');
            },

            create: function ()
            {
                this.cameras.main.fadeIn(3000);
                this.add.image(0, 0, 'die').setOrigin(0); //Dark Souls end screen, will have to change but its a good placeholder
            },

            update: function()
            {

            }

            });

        var GameWinScene = new Phaser.Class({

            Extends: Phaser.Scene,

            initialize:

            function GameWinScene ()
            {
                Phaser.Scene.call(this, { key: 'win' });
            },

            init: function()
            {

            },

            preload: function ()
            {
                this.load.image('winner', 'testob/win.png');
            },

            create: function ()
            {
                this.cameras.main.fadeIn(3000);
                this.add.image(0, 0, 'winner').setOrigin(0); //Dark Souls end screen, will have to change but its a good placeholder
            },

            update: function()
            {

            }

            }); 

            var config = {
                type: Phaser.AUTO,
                width: 1280,
                height: 720,
                physics: {
                    default: 'arcade',
                    arcade: {
                        gravity: { y: 300 },
                        debug: false    //disables visible object outlines and paths
                    }
                },
                scene: [ StartScene, GameScene, GameOverScene, GameWinScene ]
            };

            var game = new Phaser.Game(config);

    </script>